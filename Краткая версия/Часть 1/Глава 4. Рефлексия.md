# Глава 4: Рефлексия

## Обзор паттерна

Рефлексия — паттерн самооценки и самоулучшения, где агент анализирует свою работу и итеративно улучшает результат. Вводится контур обратной связи вместо простой передачи выхода.

**Процесс рефлексии:**
1. **Выполнение:** Генерация первоначального результата
2. **Оценка/Критика:** Анализ результата на корректность, связность, полноту
3. **Рефлексия/Уточнение:** Определение улучшений на основе критики
4. **Итерация:** Повторение до достижения качества

## Модель Producer-Critic

Разделение на две роли повышает объективность:

- **Продюсер:** Генерирует первоначальный контент
- **Критик:** Анализирует работу Продюсера, выявляет недочёты и предлагает улучшения

Разделение снижает когнитивную предвзятость самопроверки.

## Практические применения

1. **Генерация контента:** Черновик → оценка связности/тона → переписывание → повторение

2. **Генерация кода:** Написание → поиск ошибок → исправление

3. **Анализ данных:** Первичный анализ → проверка статистики → уточнение

4. **Суммаризация:** Генерация сводки → сверка с оригиналом → дополнение недостающего

5. **Планирование:** Создание плана → выявление слабых мест → корректировка

## Практический пример кода

```python
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0.7)

# Продюсер
producer_prompt = ChatPromptTemplate.from_template(
    "Write a blog post about: {topic}"
)

# Критик
critic_prompt = ChatPromptTemplate.from_template(
    """Analyze this blog post:
    {draft}
    
    Provide structured critique:
    - Strengths
    - Weaknesses
    - Suggestions for improvement"""
)

# Улучшатель
refiner_prompt = ChatPromptTemplate.from_template(
    """Original draft:
    {draft}
    
    Critique:
    {critique}
    
    Rewrite incorporating feedback."""
)

# Цикл рефлексии
def reflection_loop(topic, max_iterations=3):
    draft = (producer_prompt | llm).invoke({"topic": topic})
    
    for i in range(max_iterations):
        critique = (critic_prompt | llm).invoke({"draft": draft})
        draft = (refiner_prompt | llm).invoke({
            "draft": draft, 
            "critique": critique
        })
    
    return draft

result = reflection_loop("Будущее ИИ")
print(result)
```

## Связь с другими паттернами

- **Постановка целей (Глава 11):** Цель задаёт эталон для самооценки
- **Управление памятью (Глава 8):** История обеспечивает контекст для оценки и предотвращает повторение ошибок

## Ключевые выводы

- Рефлексия вводит контур обратной связи для итеративного улучшения
- Разделение Producer-Critic повышает объективность оценки
- Итеративный процесс: выполнение → оценка → уточнение
- Эффективна для генерации контента, кода, анализа, планирования
- Интегрируется с памятью и целями для накопительного улучшения
