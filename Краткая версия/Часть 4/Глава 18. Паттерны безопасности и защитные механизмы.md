# Глава 18: Паттерны безопасности и защитные механизмы

## Обзор паттерна

Безопасность агентных систем критична для защиты от злоупотреблений, утечек данных и некорректного поведения. Включает защиту входов, выходов и внутренних процессов.

## Угрозы безопасности

**1. Prompt Injection:**
- Внедрение вредоносных инструкций
- Обход ограничений системы
- Манипуляция поведением

**2. Data Leakage:**
- Утечка конфиденциальных данных
- Извлечение системных промптов
- Разглашение обучающих данных

**3. Токсичный контент:**
- Генерация оскорблений
- Пропаганда вреда
- Дискриминационные высказывания

**4. Злоупотребление инструментами:**
- Несанкционированные действия
- Превышение полномочий
- Вредоносные операции

## Защитные механизмы

**1. Input Sanitization:**
```python
def sanitize_input(user_input):
    """Очистка пользовательского ввода"""
    # Удаление опасных паттернов
    dangerous_patterns = [
        "ignore previous instructions",
        "system prompt",
        "admin mode"
    ]
    
    for pattern in dangerous_patterns:
        if pattern.lower() in user_input.lower():
            raise SecurityError("Обнаружена попытка injection")
    
    return user_input
```

**2. Output Filtering:**
```python
def filter_output(response):
    """Фильтрация выходных данных"""
    sensitive_patterns = [
        r'\b\d{16}\b',  # Номера карт
        r'\b\d{3}-\d{2}-\d{4}\b',  # SSN
        r'API[_-]?KEY'  # API ключи
    ]
    
    import re
    for pattern in sensitive_patterns:
        response = re.sub(pattern, '[REDACTED]', response)
    
    return response
```

**3. Guardrails:**
- Контроль тематики ответов
- Проверка токсичности
- Валидация фактов

**4. Access Control:**
- Аутентификация пользователей
- Авторизация действий
- Ограничение инструментов

## Практический пример кода

```python
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate

class SecureAgent:
    def __init__(self):
        self.llm = ChatOpenAI(model="gpt-4o")
        self.allowed_tools = ['search', 'calculator']
        self.user_permissions = {}
    
    def sanitize_input(self, user_input):
        """Проверка на injection"""
        injection_keywords = [
            "ignore previous", "system prompt", 
            "admin", "override"
        ]
        
        if any(kw in user_input.lower() for kw in injection_keywords):
            raise SecurityError("Обнаружена попытка injection")
        
        return user_input
    
    def filter_output(self, response):
        """Удаление конфиденциальных данных"""
        import re
        # Маскирование email
        response = re.sub(
            r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b',
            '[EMAIL]',
            response
        )
        return response
    
    def check_permissions(self, user_id, tool):
        """Проверка прав доступа"""
        user_tools = self.user_permissions.get(user_id, [])
        if tool not in user_tools:
            raise PermissionError(f"Нет доступа к {tool}")
    
    def safe_execute(self, user_id, query, tool=None):
        """Безопасное выполнение запроса"""
        # Проверки безопасности
        query = self.sanitize_input(query)
        
        if tool:
            self.check_permissions(user_id, tool)
        
        # Выполнение
        response = self.llm.invoke(query).content
        
        # Фильтрация выхода
        response = self.filter_output(response)
        
        return response

# Использование
agent = SecureAgent()
agent.user_permissions['user123'] = ['search']

result = agent.safe_execute('user123', "Найди информацию о Python")
print(result)
```

## Лучшие практики

1. **Принцип наименьших привилегий:** Минимум необходимых прав
2. **Defense in depth:** Множественные слои защиты
3. **Fail secure:** Безопасный отказ при ошибке
4. **Logging и аудит:** Отслеживание всех действий
5. **Regular updates:** Обновление защит

## Compliance

- **GDPR:** Защита персональных данных
- **HIPAA:** Медицинская информация
- **PCI DSS:** Платёжные данные
- **SOC 2:** Безопасность сервисов

## Ключевые выводы

- Безопасность критична для агентных систем
- Input sanitization предотвращает injection
- Output filtering защищает конфиденциальность
- Guardrails контролируют поведение
- Access control ограничивает действия
- Многоуровневая защита (defense in depth)
- Compliance с регуляторными требованиями
- Постоянный мониторинг и обновление
