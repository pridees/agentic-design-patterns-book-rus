# Глава 13: Человек в контуре (Human-in-the-Loop)

## Обзор паттерна

Human-in-the-Loop (HITL) — паттерн интеграции человеческого участия в рабочий процесс агента для критических решений, валидации и обратной связи. Балансирует автономность с человеческим контролем.

**Типы участия:**
- **Одобрение:** Подтверждение перед действием
- **Коррекция:** Исправление ошибок агента
- **Обратная связь:** Обучение и улучшение
- **Эскалация:** Передача сложных случаев

## Сценарии использования HITL

**Когда необходим HITL:**
- Критические решения (финансы, медицина, право)
- Высокие риски (необратимые действия)
- Этические дилеммы
- Неопределённые ситуации
- Обучение новых агентов

## Практические применения

- **Финансы:** Одобрение крупных транзакций
- **Медицина:** Подтверждение диагнозов и лечения
- **Юридические системы:** Проверка правовых документов
- **Контент-модерация:** Решение спорных случаев
- **Автоматизация HR:** Одобрение найма

## Практический пример кода

```python
from langchain.agents import Tool, AgentExecutor
from langchain_openai import ChatOpenAI

class HumanInTheLoopAgent:
    def __init__(self):
        self.llm = ChatOpenAI(model="gpt-4o")
        self.pending_actions = []
    
    def request_approval(self, action, context):
        """Запрос одобрения у человека"""
        print(f"\n=== ТРЕБУЕТСЯ ОДОБРЕНИЕ ===")
        print(f"Действие: {action}")
        print(f"Контекст: {context}")
        
        response = input("Одобрить? (yes/no/modify): ").lower()
        
        if response == "yes":
            return {"approved": True, "action": action}
        elif response == "modify":
            modified = input("Введите изменённое действие: ")
            return {"approved": True, "action": modified}
        else:
            return {"approved": False, "reason": "Отклонено пользователем"}
    
    def execute_with_approval(self, action, threshold=0.8):
        """Выполнение с одобрением для критических действий"""
        confidence = self.assess_confidence(action)
        
        if confidence < threshold:
            approval = self.request_approval(action, f"Уверенность: {confidence}")
            if not approval["approved"]:
                return f"Действие отменено: {approval['reason']}"
            action = approval["action"]
        
        return self.execute_action(action)
    
    def assess_confidence(self, action):
        """Оценка уверенности в действии"""
        # Упрощённая оценка
        import random
        return random.uniform(0.5, 1.0)
    
    def execute_action(self, action):
        """Выполнение действия"""
        return f"Выполнено: {action}"

# Использование
agent = HumanInTheLoopAgent()

result = agent.execute_with_approval(
    "Перевести $10,000 на счёт X",
    threshold=0.9
)
print(result)
```

## Уровни автономности

1. **Полная автоматизация:** Нет участия человека
2. **Уведомление:** Информирование о действиях
3. **Подтверждение:** Одобрение перед выполнением
4. **Совместное решение:** Человек и агент вместе
5. **Полный контроль:** Человек принимает все решения

## Преимущества и компромиссы

**Преимущества:**
- Снижение рисков критических ошибок
- Этическая подотчётность
- Обучение агента на обратной связи
- Доверие пользователей

**Компромиссы:**
- Снижение скорости выполнения
- Требует доступности человека
- Возможность усталости от решений
- Масштабируемость ограничена

## Ключевые выводы

- HITL балансирует автономность и контроль
- Критичен для высокорисковых решений
- Включает одобрение, коррекцию, обратную связь
- Различные уровни автономности для разных задач
- Повышает доверие и этическую подотчётность
- Компромисс между безопасностью и эффективностью
- Обеспечивает обучение и улучшение агента
